<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anime Ultra Pro - Auto Bot</title>
    <style>
        :root { --primary: #818cf8; --bg: #09090b; --card-bg: #18181b; --text: #fafafa; --border: #27272a; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', system-ui, sans-serif; margin: 0; padding-bottom: 90px; overflow-x: hidden; }
        header { background: rgba(15, 15, 18, 0.9); backdrop-filter: blur(15px); padding: 12px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); }
        .header-controls { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; height: 38px; }
        .search-bar { flex: 1; min-width: 0; padding: 0 12px; border-radius: 10px; border: 1px solid #3f3f46; background: #000; color: white; outline: none; font-size: 0.9rem; height: 100%; }
        .pill { flex: 0 0 65px; height: 100%; background: #27272a; border: 1px solid #3f3f46; color: white; border-radius: 10px; font-size: 0.65rem; font-weight: 800; display: flex; align-items: center; justify-content: center; text-transform: uppercase; cursor: pointer; }
        .pill.active { background: var(--primary); color: #000; border-color: var(--primary); }
        .continue-section { padding: 12px 12px 0 12px; display: none; }
        .continue-scroll { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .continue-card { flex: 0 0 145px; border-radius: 8px; overflow: hidden; background: var(--card-bg); border: 1px solid var(--border); cursor: pointer; }
        .continue-card img { width: 100%; aspect-ratio: 16/9; object-fit: cover; opacity: 0.8; }
        .continue-info { padding: 6px; }
        .continue-title { font-size: 0.65rem; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .continue-ep { color: var(--primary); font-size: 0.6rem; font-weight: 800; }
        .anime-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 10px; padding: 12px; }
        .card { cursor: pointer; background: var(--card-bg); border-radius: 12px; overflow: hidden; position: relative; border: 1px solid var(--border); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .card-title { font-size: 0.7rem; font-weight: 500; height: 2.6em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.2; padding: 6px; text-align: center; }
        #player-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; display: none; overflow-y: auto; }
        .video-box { width: 100%; aspect-ratio: 16/9; background: #000; position: sticky; top: 0; z-index: 10; }
        iframe { width: 100%; height: 100%; border: none; }
        .ui-section { padding: 15px; background: var(--bg); }
        .label { color: #71717a; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; margin: 15px 0 8px 0; letter-spacing: 0.5px; }
        .server-group { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .srv-btn { flex: 0 0 auto; padding: 10px 20px; background: #18181b; border: 1px solid var(--border); color: white; border-radius: 8px; font-size: 0.7rem; font-weight: bold; }
        .srv-btn.active { background: var(--primary); color: #000; border-color: var(--primary); }
        .ep-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 8px; }
        .ep-btn { padding: 10px; background: #18181b; border: 1px solid var(--border); border-radius: 8px; text-align: center; font-size: 0.8rem; cursor: pointer; }
        .ep-btn.active { border-color: var(--primary); color: var(--primary); }
        .close-btn { background:#ef4444; color:white; border:none; width:100%; padding:14px; font-weight:bold; cursor: pointer; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background: rgba(15, 15, 18, 0.95); backdrop-filter: blur(10px); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border); z-index: 500; }
        .nav-tab { background: none; border: none; color: #71717a; font-size: 0.7rem; font-weight: bold; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .nav-tab.active { color: var(--primary); }
    </style>
</head>
<body>

    <header id="main-header">
        <div class="header-controls">
            <input type="text" id="search-in" class="search-bar" placeholder="Search anime..." oninput="doSearch(this.value)">
            <button id="lang-toggle" class="pill" onclick="toggleLang()">ENG</button>
        </div>
    </header>

    <div id="continue-watching" class="continue-section">
        <div class="label">Continue Watching</div>
        <div id="continue-list" class="continue-scroll"></div>
    </div>

    <div id="player-view">
        <button class="close-btn" onclick="closePlayer()">‚úï CLOSE PLAYER</button>
        <div class="video-box" id="vid-shell"></div>
        <div class="ui-section">
            <div id="bot-status" style="color:var(--primary); font-size:0.7rem; margin-bottom:10px; font-weight: bold;"></div>
            <div class="label">Servers</div>
            <div id="server-list" class="server-group"></div>
            <div class="label">Episodes</div>
            <div id="ep-list" class="ep-grid"></div>
            <h2 id="view-title" style="margin: 20px 0 5px 0; font-size: 1.2rem;"></h2>
            <p id="view-desc" style="color:#a1a1aa; font-size: 0.8rem; line-height: 1.4;"></p>
        </div>
    </div>

    <div id="main-grid" class="anime-grid"></div>

    <nav class="bottom-nav">
        <button id="tab-home" class="nav-tab active" onclick="nav('home')">üè† Home</button>
        <button id="tab-list" class="nav-tab" onclick="nav('list')">üîñ My List</button>
    </nav>

    <script>
        const API_BASE = "https://api.consumet.org/anime/gogoanime";
        let watchlist = JSON.parse(localStorage.getItem('animeList')) || {};
        let history = JSON.parse(localStorage.getItem('animeHistory')) || {};
        let isEng = true, currentAnimeData = null;

        // --- SEARCH ENGINE ---
        async function doSearch(q) {
            if (q.length < 3) return;
            document.getElementById('bot-status').innerText = "Searching...";
            try {
                const res = await fetch(`${API_BASE}/${encodeURIComponent(q)}`);
                const data = await res.json();
                draw(data.results);
            } catch (e) { console.error(e); }
        }

        function draw(results) {
            const grid = document.getElementById('main-grid');
            grid.innerHTML = results.map(a => `
                <div class="card" onclick="openAnime('${a.id}')">
                    <img src="${a.image}">
                    <div class="card-title">${a.title}</div>
                </div>
            `).join('');
        }

        // --- BOT AUTO-FETCHER ---
        async function openAnime(id) {
            document.getElementById('player-view').style.display = 'block';
            document.getElementById('bot-status').innerText = "ü§ñ Bot finding episodes...";
            document.getElementById('ep-list').innerHTML = "";
            document.getElementById('server-list').innerHTML = "";

            try {
                const res = await fetch(`${API_BASE}/info/${id}`);
                const data = await res.json();
                currentAnimeData = data;

                document.getElementById('view-title').innerText = data.title;
                document.getElementById('view-desc').innerText = data.description || "No description available.";
                
                document.getElementById('ep-list').innerHTML = data.episodes.map(ep => `
                    <div class="ep-btn" id="ep-${ep.number}" onclick="loadEpisode('${ep.id}', ${ep.number})">${ep.number}</div>
                `).join('');

                loadEpisode(data.episodes[0].id, 1);
            } catch (e) { document.getElementById('bot-status').innerText = "Bot Error: No info found."; }
        }

        async function loadEpisode(epId, num) {
            document.querySelectorAll('.ep-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`ep-${num}`)?.classList.add('active');
            document.getElementById('bot-status').innerText = "ü§ñ Bot scanning servers...";
            document.getElementById('vid-shell').innerHTML = "<div style='color:white;text-align:center;padding:50px;'>Extracting mirrors...</div>";

            try {
                const res = await fetch(`${API_BASE}/servers/${epId}`);
                const servers = await res.json();

                // AUTOMATICALLY PUT VOE FIRST
                const sorted = servers.sort((a,b) => a.name.toLowerCase().includes('voe') ? -1 : 1);

                document.getElementById('server-list').innerHTML = sorted.map((s, i) => `
                    <button class="srv-btn ${i===0?'active':''}" onclick="playSource('${s.url}', this)">${s.name}</button>
                `).join('');

                playSource(sorted[0].url);
                saveHistory(num);
                document.getElementById('bot-status').innerText = "Bot: Links Ready.";
            } catch (e) { document.getElementById('bot-status').innerText = "Bot Error: No links found."; }
        }

        function playSource(url, btn) {
            if(btn) {
                document.querySelectorAll('.srv-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            document.getElementById('vid-shell').innerHTML = `<iframe src="${url}" allowfullscreen></iframe>`;
        }

        // --- UTILS ---
        function saveHistory(num) {
            history[currentAnimeData.id] = { epNum: num, data: currentAnimeData, time: Date.now() };
            localStorage.setItem('animeHistory', JSON.stringify(history));
            updateContinueShelf();
        }

        function updateContinueShelf() {
            const shelf = document.getElementById('continue-watching');
            const list = document.getElementById('continue-list');
            const items = Object.values(history).sort((a,b) => b.time - a.time);
            if(items.length === 0) return;
            shelf.style.display = 'block';
            list.innerHTML = items.map(item => `
                <div class="continue-card" onclick="openAnime('${item.data.id}')">
                    <img src="${item.data.image}">
                    <div class="continue-info">
                        <div class="continue-title">${item.data.title}</div>
                        <div class="continue-ep">EP ${item.epNum}</div>
                    </div>
                </div>`).join('');
        }

        function closePlayer() {
            document.getElementById('player-view').style.display = 'none';
            document.getElementById('vid-shell').innerHTML = '';
        }

        function nav(p) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-'+p).classList.add('active');
            if(p === 'home') fetchTop();
        }

        async function fetchTop() {
            const res = await fetch(`${API_BASE}/top-airing`);
            const data = await res.json();
            draw(data.results);
        }

        fetchTop();
        updateContinueShelf();
    </script>
</body>
</html>
